<?xml version="1.0" encoding="UTF-8"?>
<tmfxml xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/tracecompass/tracecompass/master/tmf/org.eclipse.tracecompass.tmf.analysis.xml.core/src/org/eclipse/tracecompass/tmf/analysis/xml/core/module/xmlDefinition.xsd">
	<stateProvider id="org.orbcode.tracing.rtos.analysis" version="4">
		<head>
			<label value="RTOS analysis" />
		</head>

		<definedValue name="CREATED" value="0" />
		<definedValue name="RUNNING" value="1" />
		<definedValue name="BLOCKED" value="2" />
		<definedValue name="NO_TASK" value="3" />
		<definedValue name="READY" value="4" />
		<definedValue name="DELAYED" value="5" />

		<definedValue name="LOCKED" value="10" />
		<definedValue name="UNLOCKED" value="11" />

		<eventHandler eventName="task_created">
			<stateChange>
				<stateAttribute type="constant" value="Task" />
				<stateAttribute type="eventField" value="TaskName" />
				<stateAttribute type="constant" value="State" />
				<stateValue type="int" value="$CREATED"/>
			</stateChange>
		</eventHandler>

		<eventHandler eventName="task_switched_in">
			<stateChange>
				<stateAttribute type="constant" value="Task" />
				<stateAttribute type="eventField" value="TaskName" />
				<stateAttribute type="constant" value="State" />
				<stateValue type="int" value="$RUNNING" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="CurrentTask" />
				<stateValue type="eventField" value="TaskName" />
				
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="ReadyTaskCount" />
				<stateValue type="script" forcedType="int"
					value="(count == null ? 0 : count) - (task_name == 'IDLE' ? 1 : 1)">
					<stateValue id="count" type="query" forcedType="int">
						<stateAttribute type="constant" value="ReadyTaskCount" />
					</stateValue>
					<stateValue id="task_name" type="eventField"
						value="TaskName" />
				</stateValue>
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="Task" />
				<stateAttribute type="eventField" value="TaskName" />
				<stateAttribute type="constant" value="BlockedOn" />
				<stateValue type="null" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="Task" />
				<stateAttribute type="eventField" value="TaskName" />
				<stateAttribute type="constant" value="BlockedOn" />
				<stateAttribute type="constant" value="Type" />
				<stateValue type="null" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="Task" />
				<stateAttribute type="eventField" value="TaskName" />
				<stateAttribute type="constant" value="BlockedOn" />
				<stateAttribute type="constant" value="Address" />
				<stateValue type="null" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="Task" />
				<stateAttribute type="eventField" value="TaskName" />
				<stateAttribute type="constant" value="BlockedOn" />
				<stateAttribute type="constant" value="Operation" />
				<stateValue type="null" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="task_switched_out">
			<stateChange>
				<if>
					<condition operator="eq">
						<stateValue type="eventField" value="OutState" />
						<stateValue type="string" value="Blocked" />
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="Task" />
					<stateAttribute type="eventField" value="TaskName" />
					<stateAttribute type="constant" value="State" />
					<stateValue type="int" value="$BLOCKED" />
				</then>
				<else>
					<if>
						<condition operator="eq">
							<stateValue type="eventField" value="OutState" />
							<stateValue type="string" value="Ready" />
						</condition>
					</if>
					<then>
						<stateAttribute type="constant" value="Task" />
						<stateAttribute type="eventField" value="TaskName" />
						<stateAttribute type="constant" value="State" />
						<stateValue type="int" value="$READY" />
					</then>
					<else>
						<if>
							<condition operator="eq">
								<stateValue type="eventField" value="OutState" />
								<stateValue type="string" value="Delayed" />
							</condition>
						</if>
						<then>
							<stateAttribute type="constant" value="Task" />
							<stateAttribute type="eventField" value="TaskName" />
							<stateAttribute type="constant" value="State" />
							<stateValue type="int" value="$DELAYED" />
						</then>
						<else>
							<stateAttribute type="constant" value="Task" />
							<stateAttribute type="eventField" value="TaskName" />
							<stateAttribute type="constant" value="State" />
							<stateValue type="int" value="777" />
						</else>
					</else>
				</else>
			</stateChange>
			<stateChange>
				<if>
					<condition operator="eq">
						<stateValue type="eventField" value="OutState" />
						<stateValue type="string" value="Ready" />
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="ReadyTaskCount" />
					<stateValue type="int" value="1" increment="true" />
				</then>
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="CurrentTask" />
				<stateValue type="string" value="$NO_TASK" />
			</stateChange>
			<stateChange>
				<if>
					<condition operator="eq">
						<stateValue type="string" value="Blocked" />
						<stateValue type="eventField" value="OutState" />
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="Task" />
					<stateAttribute type="eventField" value="TaskName" />
					<stateAttribute type="constant" value="BlockedOn" />
					<stateValue type="script"
						value="objectType + '/' + objectAddress + (operation != '' ? '/' + operation : '')">
						<stateValue id="objectAddress" type="eventField"
							value="BlockedOnObject" />
						<stateValue id="operation" type="eventField"
							value="BlockingOperation" />
						<stateValue id="objectType" type="eventField"
							value="BlockedOn" />
					</stateValue>
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition operator="eq">
						<stateValue type="string" value="Blocked" />
						<stateValue type="eventField" value="OutState" />
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="Task" />
					<stateAttribute type="eventField" value="TaskName" />
					<stateAttribute type="constant" value="BlockedOn" />
					<stateAttribute type="constant" value="Type" />
					<stateValue type="eventField" value="BlockedOn" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition operator="eq">
						<stateValue type="string" value="Blocked" />
						<stateValue type="eventField" value="OutState" />
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="Task" />
					<stateAttribute type="eventField" value="TaskName" />
					<stateAttribute type="constant" value="BlockedOn" />
					<stateAttribute type="constant" value="Address" />
					<stateValue type="eventField" value="BlockedOnObject" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition operator="eq">
						<stateValue type="string" value="Blocked" />
						<stateValue type="eventField" value="OutState" />
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="Task" />
					<stateAttribute type="eventField" value="TaskName" />
					<stateAttribute type="constant" value="BlockedOn" />
					<stateAttribute type="constant" value="Operation" />
					<stateValue type="eventField" value="BlockingOperation" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition operator="eq">
						<stateValue type="string" value="Blocked" />
						<stateValue type="eventField" value="OutState" />
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="Task" />
					<stateAttribute type="eventField" value="TaskName" />
					<stateAttribute type="constant" value="BlockLog" />
					<stateAttribute type="eventField" value="BlockedOnObject" />
					<stateValue type="eventField" value="BlockingOperation" />
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition operator="eq">
						<stateValue type="string" value="Ready" />
						<stateValue type="eventField" value="OutState" />
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="Task" />
					<stateAttribute type="eventField" value="TaskName" />
					<stateAttribute type="constant" value="PreemptedCount" />
					<stateValue type="int" value="1" increment="true" />
				</then>
			</stateChange>
		</eventHandler>

		<eventHandler eventName="task_readied">
			<stateChange>
				<if>
					<and>
						<condition operator="ne">
							<stateValue type="int" value="$READY" />
							<stateValue id="current_state" type="query">
								<stateAttribute type="constant" value="Task" />
								<stateAttribute type="eventField"
									value="TaskName" />
								<stateAttribute type="constant" value="State" />
							</stateValue>
						</condition>
						<condition operator="ne">
							<stateValue type="int" value="$RUNNING" />
							<stateValue id="current_state" type="query">
								<stateAttribute type="constant" value="Task" />
								<stateAttribute type="eventField"
									value="TaskName" />
								<stateAttribute type="constant" value="State" />
							</stateValue>
						</condition>
					</and>
				</if>
				<then>
					<stateAttribute type="constant" value="ReadyTaskCount" />
					<stateValue type="int" value="1" increment="true" />
					<!--                    <stateValue type="script" forcedType="int"
					value="(count || 0) + 1">-->
					<!--                        <stateValue id="count" type="query">-->
					<!--                            <stateAttribute type="constant"
					value="ReadyTaskCount"/>-->
					<!--                        </stateValue>-->
					<!--                    </stateValue>-->
				</then>
			</stateChange>
			<stateChange>
				<if>
					<condition operator="ne">
						<stateValue type="int" value="$RUNNING" />
						<stateValue id="current_state" type="query">
							<stateAttribute type="constant" value="Task" />
							<stateAttribute type="eventField" value="TaskName" />
							<stateAttribute type="constant" value="State" />
						</stateValue>
					</condition>
				</if>
				<then>
					<stateAttribute type="constant" value="Task" />
					<stateAttribute type="eventField" value="TaskName" />
					<stateAttribute type="constant" value="State" />
					<stateValue type="int" value="$READY" />
				</then>
			</stateChange>
		</eventHandler>

		<eventHandler eventName="binary_semaphore_created">
			<stateChange>
				<stateAttribute type="constant" value="BinarySemaphore" />
				<stateAttribute type="eventField" value="Semaphore" />
				<stateAttribute type="constant" value="State" />
				<stateValue type="int" value="$CREATED" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="BinarySemaphore" />
				<stateAttribute type="eventField" value="Semaphore" />
				<stateAttribute type="constant" value="LockedBy" />
				<stateValue type="string" value="$NO_TASK" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="binary_semaphore_locked">
			<stateChange>
				<stateAttribute type="constant" value="BinarySemaphore" />
				<stateAttribute type="eventField" value="Semaphore" />
				<stateAttribute type="constant" value="State" />
				<stateValue type="int" value="$LOCKED" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="BinarySemaphore" />
				<stateAttribute type="eventField" value="Semaphore" />
				<stateAttribute type="constant" value="LockedBy" />
				<stateValue type="eventField" value="TaskName" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="binary_semaphore_unlocked">
			<stateChange>
				<stateAttribute type="constant" value="BinarySemaphore" />
				<stateAttribute type="eventField" value="Semaphore" />
				<stateAttribute type="constant" value="State" />
				<stateValue type="int" value="$UNLOCKED" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="BinarySemaphore" />
				<stateAttribute type="eventField" value="Semaphore" />
				<stateAttribute type="constant" value="LockedBy" />
				<stateValue type="string" value="$NO_TASK" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="mutex_created">
			<stateChange>
				<stateAttribute type="constant" value="Mutex" />
				<stateAttribute type="eventField" value="Mutex" />
				<stateAttribute type="constant" value="State" />
				<stateValue type="int" value="$CREATED" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="Mutex" />
				<stateAttribute type="eventField" value="Mutex" />
				<stateAttribute type="constant" value="LockedBy" />
				<stateValue type="string" value="$NO_TASK" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="mutex_locked">
			<stateChange>
				<stateAttribute type="constant" value="Mutex" />
				<stateAttribute type="eventField" value="Mutex" />
				<stateAttribute type="constant" value="State" />
				<stateValue type="int" value="$LOCKED" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="Mutex" />
				<stateAttribute type="eventField" value="Mutex" />
				<stateAttribute type="constant" value="LockedBy" />
				<stateValue type="eventField" value="TaskName" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="mutex_unlocked">
			<stateChange>
				<stateAttribute type="constant" value="Mutex" />
				<stateAttribute type="eventField" value="Mutex" />
				<stateAttribute type="constant" value="State" />
				<stateValue type="int" value="$UNLOCKED" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="Mutex" />
				<stateAttribute type="eventField" value="Mutex" />
				<stateAttribute type="constant" value="LockedBy" />
				<stateValue type="string" value="$NO_TASK" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="queue_created">
			<stateChange>
				<stateAttribute type="constant" value="Queue" />
				<stateAttribute type="eventField" value="Queue" />
				<stateAttribute type="constant" value="Count" />
				<stateValue type="int" value="0" />
			</stateChange>
			<stateChange>
				<stateAttribute type="constant" value="Queue" />
				<stateAttribute type="eventField" value="Queue" />
				<stateAttribute type="constant" value="Capacity" />
				<stateValue type="eventField" value="Capacity" forcedType="int" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="queue_pushed">
			<stateChange>
				<stateAttribute type="constant" value="Queue" />
				<stateAttribute type="eventField" value="Queue" />
				<stateAttribute type="constant" value="Count" />
				<stateValue type="eventField" value="UpdatedItemsCount"
					forcedType="int" />
			</stateChange>
		</eventHandler>

		<eventHandler eventName="queue_popped">
			<stateChange>
				<stateAttribute type="constant" value="Queue" />
				<stateAttribute type="eventField" value="Queue" />
				<stateAttribute type="constant" value="Count" />
				<stateValue type="eventField" value="UpdatedItemsCount"
					forcedType="int" />
			</stateChange>
		</eventHandler>
	</stateProvider>
</tmfxml>